{% block title %}Deploy - CloudBerry Cluster Deployment{% endblock %}

{% block deployment_status %}
<div class="deployment-status">
    <h3><i class="fas fa-info-circle"></i> Deployment Status</h3>
    <div class="status-info">
        <div class="status-item">
            <strong>Deployment Mode</strong>
            <span>{{ deployment_info.mode|default('Not configured') }}</span>
        </div>
        <div class="status-item">
            <strong>Coordinator Host</strong>
            <span>{{ deployment_info.coordinator|default('Not set') }}</span>
        </div>
        <div class="status-item">
            <strong>Segment Hosts</strong>
            <span>{{ deployment_info.segment_count|default(0) }} hosts</span>
        </div>
        <div class="status-item">
            <strong>Status</strong>
            <span id="deploymentStatus">{{ deployment_info.status|default('Ready') }}</span>
        </div>
    </div>

    {% if deployment_info.status == 'running' %}
    <div class="progress">
        <div class="progress-bar" id="progressBar" style="width: {{ deployment_info.progress|default(0) }}%">
            {{ deployment_info.progress|default(0) }}%
        </div>
    </div>
    {% endif %}

    <div style="margin-top: 15px;">
        <button type="button" class="btn btn-secondary" onclick="refreshLogs()">
            <i class="fas fa-sync"></i> Refresh Logs
        </button>
        <button type="button" class="btn btn-info" onclick="downloadLogs()" 
                {% if not deployment_info.log_file %}disabled{% endif %}>
            <i class="fas fa-download"></i> Download Logs
        </button>
    </div>

    <div class="logs-container" id="deploymentLogs">
        {{ deployment_info.logs|default('No logs available. Start deployment to see logs.') }}
    </div>
</div>
{% endblock %}

{% block content %}
<div class="deploy-section">
    <h2><i class="fas fa-rocket"></i> Deploy Cluster</h2>
    <p>Review your configuration and start the deployment process</p>

    <!-- Deployment Status -->
    <div class="deployment-status">
        <h3><i class="fas fa-info-circle"></i> Deployment Status</h3>
        <div class="status-grid">
            <div class="status-item">
                <strong>Deployment Mode:</strong>
                <span>{{ config.DEPLOY_TYPE|default('single') }}</span>
            </div>
            <div class="status-item">
                <strong>Coordinator:</strong>
                <span>{{ config.COORDINATOR_HOSTNAME|default('Not configured') }}</span>
            </div>
            <div class="status-item">
                <strong>Segment Hosts:</strong>
                <span>{{ hosts.segment_hosts|length if hosts.segment_hosts else 0 }} hosts</span>
            </div>
            <div class="status-item">
                <strong>Status:</strong>
                <span id="deploymentStatus" class="status-badge">{{ deployment_info.status|default('Ready') }}</span>
            </div>
        </div>

        {% if deployment_info.status == 'running' %}
        <div class="progress-container">
            <div class="progress">
                <div class="progress-bar" id="progressBar" style="width: {{ deployment_info.progress|default(0) }}%">
                    {{ deployment_info.progress|default(0) }}%
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Deployment Actions -->
    <div class="deployment-actions">
        <form id="deployForm" method="POST" action="/deploy">
            <div class="form-check">
                <label>
                    <input type="checkbox" id="skipConsistencyCheck" name="skip_consistency_check" value="1">
                    Skip consistency check (Not recommended)
                </label>
            </div>
            
            <div class="form-check">
                <label>
                    <input type="checkbox" id="forceDeploy" name="force_deploy" value="1">
                    Force deploy (Overwrite existing installation)
                </label>
            </div>

            <div class="action-buttons">
                <button type="submit" class="btn btn-success" id="deployButton" 
                        {% if not deployment_info.ready %}disabled{% endif %}>
                    <i class="fas fa-rocket"></i> Start Deployment
                </button>
                <button type="button" class="btn btn-danger" id="cancelButton" 
                        onclick="cancelDeployment()" style="display: none;">
                    <i class="fas fa-stop"></i> Cancel Deployment
                </button>
            </div>
        </form>
    </div>

    <!-- Deployment Logs -->
    <div class="deployment-logs">
        <h3><i class="fas fa-terminal"></i> Deployment Logs</h3>
        <div class="log-controls">
            <button type="button" class="btn btn-secondary" onclick="refreshLogs()">
                <i class="fas fa-sync"></i> Refresh Logs
            </button>
            <button type="button" class="btn btn-info" onclick="downloadLogs()" 
                    {% if not deployment_info.log_file %}disabled{% endif %}>
                <i class="fas fa-download"></i> Download Logs
            </button>
        </div>
        <div class="log-container" id="deploymentLogs">
            {{ deployment_info.logs|default('No logs available. Start deployment to see logs.') }}
        </div>
    </div>
</div>

<script>
let deploymentInterval;
let isDeploying = {{ 'true' if deployment_info.status == 'running' else 'false' }};

function startDeploymentMonitoring() {
    if (isDeploying) {
        deploymentInterval = setInterval(updateDeploymentStatus, 2000);
        document.getElementById('deployButton').style.display = 'none';
        document.getElementById('cancelButton').style.display = 'inline-block';
    }
}

function updateDeploymentStatus() {
    fetch('/deployment_status')
        .then(response => response.json())
        .then(data => {
            const statusElement = document.getElementById('deploymentStatus');
            statusElement.textContent = data.status;
            statusElement.className = `status-badge status-${data.status}`;
            
            if (data.status === 'running' && data.progress !== undefined) {
                const progressBar = document.getElementById('progressBar');
                progressBar.style.width = data.progress + '%';
                progressBar.textContent = data.progress + '%';
            }
            
            if (data.status === 'completed' || data.status === 'failed') {
                clearInterval(deploymentInterval);
                isDeploying = false;
                document.getElementById('deployButton').style.display = 'inline-block';
                document.getElementById('cancelButton').style.display = 'none';
                refreshLogs();
                
                // Show completion message
                if (data.status === 'completed') {
                    showNotification('Deployment completed successfully!', 'success');
                } else if (data.status === 'failed') {
                    showNotification('Deployment failed. Please check logs.', 'error');
                }
            }
        })
        .catch(error => {
            console.error('Error updating status:', error);
            showNotification('Error checking deployment status', 'error');
        });
}

function refreshLogs() {
    fetch('/deployment_logs')
        .then(response => response.text())
        .then(logs => {
            const logsContainer = document.getElementById('deploymentLogs');
            logsContainer.textContent = logs;
            logsContainer.scrollTop = logsContainer.scrollHeight;
        })
        .catch(error => {
            console.error('Error refreshing logs:', error);
            showNotification('Error refreshing logs', 'error');
        });
}

function cancelDeployment() {
    if (confirm('Are you sure you want to cancel the deployment? This action cannot be undone.')) {
        fetch('/cancel_deployment', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                clearInterval(deploymentInterval);
                isDeploying = false;
                showNotification('Deployment cancelled', 'info');
                location.reload();
            })
            .catch(error => {
                console.error('Error cancelling deployment:', error);
                showNotification('Error cancelling deployment', 'error');
            });
    }
}

function downloadLogs() {
    window.open('/download_logs', '_blank');
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    startDeploymentMonitoring();
    
    // Handle form submission
    document.getElementById('deployForm').addEventListener('submit', function(e) {
        if (!confirm('Are you ready to start the deployment? This will take several minutes.')) {
            e.preventDefault();
            return;
        }
        
        isDeploying = true;
        startDeploymentMonitoring();
        showNotification('Deployment started successfully', 'success');
    });
});
</script>
{% endblock %}